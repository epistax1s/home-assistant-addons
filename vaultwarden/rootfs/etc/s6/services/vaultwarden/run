#!/usr/bin/with-contenv bashio
set -e
set -x   # печатать команды (можно убрать после отладки)

bashio::log.info "Starting Vaultwarden add-on v1.0.5 (debug mode)..."

# config как у тебя
DOMAIN=$(bashio::config 'domain' 'http://192.168.0.133:80')
ROCKET_PORT=$(bashio::config 'rocket_port' '80')
ADMIN_TOKEN=$(bashio::config 'admin_token')
DATA_FOLDER=$(bashio::config 'data_folder' '/config/vaultwarden')
DATABASE_URL=$(bashio::config 'database_url' "sqlite://${DATA_FOLDER}/db.sqlite3")
WEBSOCKET_ENABLED=$(bashio::config 'websocket_enabled' 'true')
SIGNUPS_ALLOWED=$(bashio::config 'signups_allowed' 'false')
INVITATIONS_ALLOWED=$(bashio::config 'invitations_allowed' 'true')
EMERGENCY_ACCESS_ALLOWED=$(bashio::config 'emergency_access_allowed' 'true')
SENDS_ALLOWED=$(bashio::config 'sends_allowed' 'true')

if [[ -z "$ADMIN_TOKEN" ]]; then
    ADMIN_TOKEN=$(openssl rand -base64 48) || true
    bashio::log.warning "No ADMIN_TOKEN set — generated (showing prefix): ${ADMIN_TOKEN:0:20}..."
fi

export DOMAIN ROCKET_PORT ADMIN_TOKEN DATA_FOLDER DATABASE_URL WEBSOCKET_ENABLED SIGNUPS_ALLOWED INVITATIONS_ALLOWED EMERGENCY_ACCESS_ALLOWED SENDS_ALLOWED
export ROCKET_ADDRESS="0.0.0.0"

bashio::log.info "=== DEBUG ENV EXPORTED ==="
bashio::log.info "DOMAIN: $DOMAIN"
bashio::log.info "ROCKET_PORT: $ROCKET_PORT"
bashio::log.info "DATA_FOLDER: $DATA_FOLDER"
bashio::log.info "DATABASE_URL: $DATABASE_URL"
bashio::log.info "ROCKET_ADDRESS: $ROCKET_ADDRESS"
bashio::log.info "========================="

# Диагностика перед exec
if [[ ! -x "/usr/bin/vaultwarden" ]]; then
    bashio::log.error "/usr/bin/vaultwarden отсутствует или не исполняемый!"
    ls -l /usr/bin || true
    # вывести содержимое errno
    bashio::log.error "Выход."
    exit 1
fi

bashio::log.info "About to exec /usr/bin/vaultwarden (trial --version)..."
# Попробуем вывести версию — если бинарь падает, увидим почему
/usr/bin/vaultwarden --version || bashio::log.error "Выполнение --version завершилось с ошибкой"

# Наконец — exec основного процесса
exec /usr/bin/vaultwarden
